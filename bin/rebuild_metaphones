#!/usr/bin/ruby

require 'rubygems'
require 'sqlite3'
require 'text'

if(ARGV.length < 1)
print "Missing SQLite file parameter"
printf "\nUSAGE:\n"
print """./rebuild_metaphones [SQLite File]
  [SQLite File] - SQLite file generated by the geocoder.
"""
exit
end

    @db = SQLite3::Database.new(ARGV[0])
    @db.create_function("metaphone", 2) do |func, string, len|
      test = string.to_s.gsub(/\W/o, "")
      if test =~ /^(\d+)/o
        mph = $1
      elsif test =~ /^([wy])$/io
        mph = $1
      else
        mph = Text::Metaphone.metaphone test
      end
      func.result = mph[0...len.to_i]
    end
    sql = "update place set city_phone = metaphone(city,5)"
    
    @db.execute sql
    
    @db.close
